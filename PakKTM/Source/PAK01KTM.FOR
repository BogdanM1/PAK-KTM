C=======================================================================
CE       GENERAL SUBROUTINES
C=======================================================================
C=======================================================================
C=======================================================================
C=======================================================================
      SUBROUTINE WIMIDZ
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
CE.    P R O G R A M
CE.        TO READ INPUT DATA AND PRINT CARD IMAGE
      CHARACTER*130 INPDAT
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
      IF (KARTIC.EQ.0) GO TO 10
      REWIND 1
   10 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(3,2000)
      IF(ISRPS.EQ.1)
     1WRITE(3,6000)
      KARD  = 0
      KARDNO = 0
 
   30 READ(1,1000,END=40) INPDAT
      KARD=KARD + 1
      KARDNO=KARDNO + 1
      IF (KARDNO.LE.50) GO TO 50
      IF(ISRPS.EQ.0)
     1WRITE(3,2010)
      IF(ISRPS.EQ.1)
     1WRITE(3,6010)
      IF(ISRPS.EQ.0)
     1WRITE(3,2000)
      IF(ISRPS.EQ.1)
     1WRITE(3,6000)
      KARDNO=1
   50 WRITE(3,5020) KARD,INPDAT
      GO TO 30
   40 CONTINUE
      IF(ISRPS.EQ.0)
     1WRITE(3,2010)
      IF(ISRPS.EQ.1)
     1WRITE(3,6010)
      IF(ISRPS.EQ.0)
     1WRITE(3,2030)
      IF(ISRPS.EQ.1)
     1WRITE(3,6030)
      KARD=KARD - KARTIC + 1
      REWIND 1
      DO 60 I=1,KARTIC
      READ(1,1000,END=60) INPDAT
   60 CONTINUE
      RETURN
 1000 FORMAT (A80)
 5020 FORMAT(I5,1X,A70)
 2000 FORMAT(///'1'//' S L E D E   K A R T I C E   L I S T I N G A   ',
     1'U L A Z N E   D A T O T E K E'/28X,'K O L O N A    B R O J'/
     1' KART',10X,
     1'1         2         3         4         5         6         7'/
     1' BROJ 1234567890123456789012345678901234567890123456789012345',
     1 '678901234567890'/' ',4('-'),1X,70('-'))
 2010 FORMAT(' ',4('-'),1X,70('-')/
     1' KART',10X,
     1'1         2         3         4         5         6         7'/
     1' BROJ 1234567890123456789012345678901234567890123456789012345',
     1 '678901234567890'/28X,'K O L O N A    B R O J')
 2030 FORMAT(//' ',19('*'),' K R A J   U L A Z N O G   L I S T I N G A '
     1,13('*'))
 6000 FORMAT(///'1'/' A   C A R D   I M A G E   L I S T I N G   O F   ',
     1'T H E   I N P U T   D A T A'/28X,'C O L U M N   N U M B E R'/
     1' CARD',10X,
     1'1         2         3         4         5         6         7'/
     1' NUMB 1234567890123456789012345678901234567890123456789012345',
     1 '678901234567890'/' ',4('-'),1X,70('-'))
 6010 FORMAT(' ',4('-'),1X,70('-')/
     1' CARD',10X,
     1'1         2         3         4         5         6         7'/
     1' NUMB 1234567890123456789012345678901234567890123456789012345',
     1 '678901234567890'/28X,'C O L U M N   N U M B E R')
 6030 FORMAT(//' ',19('*'),' E N D   O F   I N P U T   L I S T I N G ',
     115('*'))
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE WBROJK(KARTI,IND)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      CHARACTER*130 ACOZ
CE.    P R O G R A M
CE.        TO PRINT NUMBER OF READ CARDS
CE.            KARTI  - FIRST NUMBER CARDS IN GROUP
CE.            KARTIC - LAST NUMBER CARDS IN GROUP
CE.            IND    - INDICATOR (=0, CONTINUE;
CE.                                =1, NEW PAGE)
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
      IF(KARTI.EQ.KARTIC) GO TO 10
CE    READED MORE THEN ONE CARDS
      IF(IND.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2000) KARTI,KARTIC
      IF(ISRPS.EQ.1)
     1WRITE(3,6000) KARTI,KARTIC
      ENDIF
      IF(IND.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2010) KARTI,KARTIC
      IF(ISRPS.EQ.1)
     1WRITE(3,6010) KARTI,KARTIC
      ENDIF
      RETURN
CE    READED ONLY ONE CARD
   10 IF(IND.EQ.0) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2100) KARTIC
      IF(ISRPS.EQ.1)
     1WRITE(3,6100) KARTIC
      ENDIF
      IF(IND.EQ.1) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2110) KARTIC
      IF(ISRPS.EQ.1)
     1WRITE(3,6110) KARTIC
      ENDIF
      RETURN
 2000 FORMAT(//////' KARTICE OD BROJA',I5,' DO',I5///)
 2010 FORMAT(///'1'/' KARTICE OD BROJA',I5,' DO',I5///)
 2100 FORMAT(//////' KARTICA BROJ',I5///)
 2110 FORMAT(///'1'/' KARTICA BROJ',I5///)
 6000 FORMAT(//////' CARD FROM NUMBER ',I5,' TO',I5///)
 6010 FORMAT(///'1'/' CARD FROM NUMBER ',I5,' TO',I5///)
 6100 FORMAT(//////' CARD NUMBER ',I5///)
 6110 FORMAT(///'1'/' CARD NUMBER ',I5///)
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TKFORMDARCY(TT1,TT1TOT,IDT,IDARCYMA,NZADJ,ZADFM,NZADP,
     1 indiffus,IHEAT,ICONV,NDIMIDT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON A(1)
      
      DIMENSION TT1(JEDN),TT1TOT(NDIMIDT,NPT),IDT(NDIMIDT,NPT)
      DIMENSION IDARCYMA(NPT),NZADJ(3,NZADP),ZADFM(NZADP)
        
      DO 200 NODE=1,NPT
        DO 100 I = 1,2  
          TT1TOT(I,NODE) = 0.0
          IDJ =  IDT(I+2,NODE)
          IF(IDJ.NE.0) THEN
            TT1TOT(I,NODE) = TT1(IDJ)
          ELSEIF ((IDARCYMA(NODE).EQ.1.AND.I.EQ.1.AND.ICONV.EQ.1).OR.
     1      (I.EQ.2.AND.(IDT(2,NODE).EQ.0.AND.
     2      (indiffus.EQ.1.OR.IHEAT.EQ.1)))) THEN          
            IF(NZADP.EQ.0) GO TO 100            
	      DO KK=1,NZADP
	        NJ=NZADJ(1,KK)
	        IF(NJ.EQ.NODE) THEN
	          IDOF=NZADJ(2,KK)
                IF(IDOF.EQ.I) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                     IND)
                  TT1TOT(I,NODE) = FT*FAK
                  GO TO 100
                ENDIF
	        ENDIF
	      ENDDO
	    ENDIF
  100   CONTINUE
  200 CONTINUE
C
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TKFORMSMEAR(TT1P,TT1C,TT1TOT,IDT,IDARCYMA,NZADJ,ZADFM,
     1 NZADP,indiffus,IHEAT,ICONV)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON/CSMEARED2/IPASSME,JEDNPRES,JEDNCONC,LTT1P,LTT1C,LTT10P,
     1      LTT10C,LDIRCOEFF,LDPIPECAP,LDARCYCAP,I2D3D,IANIZS,NDIMTENSOR
     
      COMMON A(1)
      
      DIMENSION TT1P(JEDNPRES),TT1C(JEDNCONC),TT1TOT(4,NPT),IDT(4,NPT)
      DIMENSION IDARCYMA(NPT),NZADJ(3,NZADP),ZADFM(NZADP)
        
      DO 200 NODE=1,NPT
        DO 100 I = 1,2  
C
C         PRESSURES
C
          TT1TOT(I,NODE) = 0.0
          IDJ =  IDT(I,NODE)
          IF(IDJ.NE.0) THEN
            TT1TOT(I,NODE) = TT1P(IDJ)
          ELSEIF (IDARCYMA(NODE).EQ.1.OR.ICONV.EQ.1) THEN
            IF(NZADP.EQ.0) GO TO 101
	      DO KK=1,NZADP
	        NJ = NZADJ(1,KK)
	        IF(NJ.EQ.NODE) THEN
	          IDOF = NZADJ(2,KK)
                IF(IDOF.EQ.I) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                     IND)
                  TT1TOT(I,NODE) = FT*FAK
                  GO TO 101
                ENDIF
	        ENDIF
	      ENDDO
	    ENDIF
  101     CONTINUE
C
C         CONCENTRATIONS
C
          TT1TOT(I+2,NODE) = 0.0
          IDJ =  IDT(I+2,NODE)
          IF(IDJ.NE.0) THEN
            TT1TOT(I+2,NODE) = TT1C(IDJ)
          ELSEIF ((IDT(I+2,NODE).EQ.0.AND.
     2      (indiffus.EQ.1.OR.IHEAT.EQ.1))) THEN          
            IF(NZADP.EQ.0) GO TO 100            
	      DO KK=1,NZADP
	        NJ = NZADJ(1,KK)
	        IF(NJ.EQ.NODE) THEN
	          IDOF = NZADJ(2,KK)
                IF(IDOF.EQ.(I+2)) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                     IND)
                  TT1TOT(I+2,NODE) = FT*FAK
                  GO TO 100
                ENDIF
	        ENDIF
	      ENDDO
	    ENDIF
  100   CONTINUE 
C
  200 CONTINUE
C
      RETURN
      END
C=======================================================================
C
C=======================================================================
 	SUBROUTINE TGRAFC(CORD,NPT,II)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      DIMENSION CORD(NPT,*)
C
      REWIND II

	IND=-1
      ITYP=15
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
 1100 FORMAT(I6)
      IT1=0
      IT2=0
      ICOL=8
C
      DO 10 I=1,NPT

	  WRITE(II,1000) I,IT1,IT2,ICOL,(CORD(I,J),J=1,3)
 1000 FORMAT(4I10,3E13.5)
   10 CONTINUE
C
      WRITE(II,1100) IND
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TGRAFRDARCY(TT1TOT,IDT,VELOC,NPT,II,NASLOV,KOR,VREME,
     1  ICON,JEDN,NGET,NTOTA,IIZLAZ,NDIMIDT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)

      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON /ZADATA/ LNZADJ,LNZADF,LZADFM,NZADP
      COMMON/DARCYEQ/ ELDARCYX,ELDARCYY,ELDARCYZ,VDARCY,PINLET,
     1       DARCYX,JEDNDARCY,ISOLVER,IDARCY,LDARCYD,LDARCYMI,
     2       LIDARCYMA,NPTINDARCY
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON A(1)
      
      DIMENSION TT1TOT(NDIMIDT,NPT),IDT(NDIMIDT,NPT),VELOC(3,NPT)
c
	CHARACTER*1 NASLOV(80)
C
C     PRITISAK
C
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
 
      WRITE(II,5003) NASLOV
 5003 FORMAT(80A1)
      WRITE(II,5004) KOR
 5004 FORMAT('CVORNI PRITISAK'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5008) KOR,VREME
 5008 FORMAT(
     1   '         2         1         1        13         2         2'/
     1   '         1         1',I10/
     1   E13.5)
      
      DO IN = 1, NPT
        WRITE(II,1000) IN
	  IF(DABS(TT1TOT(1,IN)).LT.1.D-15) TT1TOT(1,IN)=0.D0
        WRITE(II,2000) TT1TOT(1,IN), 0.0
      ENDDO
      WRITE(II,1100) IND
C
C     KONCENTRACIJE
C
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,6004) KOR
 6004 FORMAT('CVORNE KONCENTRACIJE'/ 
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,6008) KOR,VREME
 6008 FORMAT(
     1   '         2         1         1         5         2         2'/
     1   '         1         1',I10/
     1   E13.5)
      DO IN = 1, NPT
        WRITE(II,1000) IN
	  IF(DABS(TT1TOT(2,IN)).LT.1.D-15) TT1TOT(2,IN)=0.D0
        WRITE(II,2000) TT1TOT(2,IN), 0.0
      ENDDO
      WRITE(II,1100) IND
C
      IF(ICON.EQ.0) RETURN
C
C     NODAL VELOCITIES
C     
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,7004) KOR
 7004 FORMAT('CVORNE BRZINE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,7008) KOR,VREME
 7008 FORMAT(
     1   '         2         1         1        11         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        WRITE(II,3000) VELOC(1,IN),VELOC(2,IN),VELOC(3,IN),0.0,0.0,0.0
      ENDDO
      WRITE(II,1100) IND 
C
 1000 FORMAT(I10)
 1100 FORMAT(I6)
 2000 FORMAT(2E15.7)
 3000 FORMAT(6E15.7)
C
C     ELEM VELOCITIES - NETIP = 1,4
C
      DO 280 NGE = 1,NGET
        NETIP     = NELEDAT(NGE,1)
        ICONECTIV = NELEDAT(NGE,10)
        
        IF(NETIP.NE.1.AND.NETIP.NE.4) GO TO 280
        IF(ICONECTIV.EQ.1) GO TO 280
        NET       = NELEDAT(NGE,2) 
        LNEL1D    = NELEDAT(NGE,7)
        LDARCYD   = NELEDAT(NGE,14)
        LDARCYMI  = NELEDAT(NGE,15)
        LEMODULUS = NELEDAT(NGE,29)
        LDELTAE   = NELEDAT(NGE,30)
        LELFLUX   = NELEDAT(NGE,32)
        IDEFORM   = NELEDAT(NGE,33)
        
        LMAXSAVE = LMAX
        call MEMORYT(LDIAMTT,LMAX,NET*2,NTOTA,IIZLAZ)
        
	  CALL PRINTEL1DUNV(IDT,A(LIDARCYMA),TT1TOT,A(LNZADJ),A(LZADFM),
	1 A(LCORD),A(LNEL1D),A(LDARCYD),A(LDARCYMI),A(LEMODULUS),
     2 A(LDELTAE),A(LELFLUX),NPT,NET,JEDN,NZADP,VREME,NASLOV,II,
     3 KOR,NETIP,IDEFORM,A(LDIAMTT),NDIMIDT)
        LMAX = LMAXSAVE  
  280 CONTINUE
C
C     ELEM FLUXES - NETIP = 1,4
C
 
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TGRAFRSMEAR(TT1TOT,IDT,VELOC,IPIPENODV,NPT,II,NASLOV,
     1  KOR,VREME, ICON,JEDN,NGET,NTOTA,IIZLAZ,IPRINTVEL,ISMEARED)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)

      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON /ZADATA/ LNZADJ,LNZADF,LZADFM,NZADP
      COMMON/DARCYEQ/ ELDARCYX,ELDARCYY,ELDARCYZ,VDARCY,PINLET,
     1       DARCYX,JEDNDARCY,ISOLVER,IDARCY,LDARCYD,LDARCYMI,
     2       LIDARCYMA,NPTINDARCY
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON A(1)
      
      DIMENSION TT1TOT(4,NPT),IDT(4,NPT),VELOC(6,NPT),IPIPENODV(NPT)
c
	CHARACTER*1 NASLOV(80)
C
C     PRITISAK
C
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
 
      WRITE(II,5003) NASLOV
 5003 FORMAT(80A1)
      WRITE(II,5004) KOR
 5004 FORMAT('CVORNI PRITISAK'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5008) KOR,VREME
 5008 FORMAT(
     1   '         2         1         1        13         2         2'/
     1   '         1         1',I10/
     1   E13.5)
C      
      DO IN = 1, NPT
        WRITE(II,1000) IN
	  IF(DABS(TT1TOT(1,IN)).LT.1.D-15) TT1TOT(1,IN)=0.D0
	  IF(DABS(TT1TOT(2,IN)).LT.1.D-15) TT1TOT(2,IN)=0.D0
	  IF(ISMEARED.EQ.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOT(1,IN), 0.0
        ELSE IF (ISMEARED.NE.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOT(1,IN), TT1TOT(1,IN) 
        ELSE
          WRITE(II,2000) TT1TOT(2,IN), TT1TOT(1,IN)
        ENDIF  
      ENDDO
      WRITE(II,1100) IND
C
C     KONCENTRACIJE
C
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,6004) KOR
 6004 FORMAT('CVORNE KONCENTRACIJE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,6008) KOR,VREME
 6008 FORMAT(
     1   '         2         1         1         5         2         2'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
	  IF(DABS(TT1TOT(4,IN)).LT.1.D-15) TT1TOT(4,IN)=0.D0
	  IF(DABS(TT1TOT(3,IN)).LT.1.D-15) TT1TOT(3,IN)=0.D0
        IF(ISMEARED.EQ.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOT(3,IN), 0.0
        ELSE IF (ISMEARED.NE.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOT(3,IN), TT1TOT(3,IN)
        ELSE
          WRITE(II,2000) TT1TOT(4,IN), TT1TOT(3,IN)
        ENDIF
      ENDDO
      WRITE(II,1100) IND
C
 1000 FORMAT(I10)
 1100 FORMAT(I6)
 2000 FORMAT(2E15.7, I5)
 3000 FORMAT(6E15.7)
C
      IF (IPRINTVEL.EQ.0) RETURN
C
C     NODAL VELOCITIES - TISSUE
C     
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,7004) KOR
 7004 FORMAT('CVORNE BRZINE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,7008) KOR,VREME
 7008 FORMAT(
     1   '         2         1         1        11         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        WRITE(II,3000) VELOC(4,IN),VELOC(5,IN),VELOC(6,IN),0.,0.,0.
      ENDDO
      WRITE(II,1100) IND 
C
C     NODAL VELOCITIES - CAPILLARY
C     
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,8004) KOR
 8004 FORMAT('CVORNE BRZINE - CAPILLARY'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,8008) KOR,VREME
 8008 FORMAT(
     1   '         2         1         1        14         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        WRITE(II,3000) VELOC(1,IN),VELOC(2,IN),VELOC(3,IN),0.,0.,0.
      ENDDO
      WRITE(II,1100) IND
C
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TGRAFR(TT1,IDT,NPT,II,NASLOV,KOR,VREME,FLUXDX,FLUXDY,
     1           FLUXDZ,FLUXDXU,FLUXDYU,FLUXDZU,ENREL,NBNODES,DIFFUSV)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
	COMMON/NANOPERE1/NANOPORE,IAXISYM,NBOUND,IABSORB,AKABS,NXV(20),
     1           BOUND(2,20),NXTOT,NYTOT,LBNODES,LBCONC,LBCONC0,LBCONC2,
     2           DMOLECULE,LFLUXB,LENREL,AVOGADRO,AVOGADROR,BMOL
      common/diffusmain/indiffus,NDS,maxdt,NPRINTnds,lvreme,leprdt,
	1                  NUMMAT,maxPmat,LMATER,LMATFUN,LAREAD,LFLUXDX,
     1                  LFLUXDY,LFLUXDZ
      DIMENSION TT1(*),IDT(*)
	DIMENSION FLUXDX(*),FLUXDY(*),FLUXDZ(*)
	DIMENSION FLUXDXU(*),FLUXDYU(*),FLUXDZU(*)
	DIMENSION ENREL(*),NBNODES(*),DIFFUSV(2,*)
	CHARACTER*1 NASLOV(80)
C
      IND=-1
      NC=1
      ITYP=55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
 1100 FORMAT(I6)
      WRITE(II,5003) NASLOV
 5003 FORMAT(80A1)
      WRITE(II,5004) KOR
 5004 FORMAT('CVORNE TEMPERATURE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5008) KOR,VREME
 5008 FORMAT(
     1   '         2         1         1         5         2         1'/
     1   '         1         1',I10/
     1   E13.5)
      DO 10 I=1,NPT
      WRITE(II,1000) I
      IN = I 
 1000 FORMAT(I10)
c      jj=idt(i)
	IF(DABS(TT1(IN)).LT.1.D-15) TT1(IN)=0.D0
      WRITE(II,2000) TT1(IN)
 2000 FORMAT(E13.5)
   10 CONTINUE
      WRITE(II,1100) IND
C
CE	FLUX X,Y,Z
      WRITE(II,1100) IND
	WRITE(II,1100) ITYP
	WRITE(II,5003) NASLOV
      WRITE(II,5006) KOR
 5009 FORMAT(
     1   '         2         1         1         7         2         1'/
     1   '         1         1',I10/
     1   E13.5)
 5006 FORMAT('MASS FLUX'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
	WRITE(II,5009) KOR,VREME
 2001 FORMAT(3E13.5)
	DO 20 I=1,NPT
      WRITE(II,1000) I
      IF(DABS(FLUXDX(I)).LT.1.D-15) FLUXDX(I)=0.D0
	IF(DABS(FLUXDY(I)).LT.1.D-15) FLUXDY(I)=0.D0
	IF(DABS(FLUXDZ(I)).LT.1.D-15) FLUXDZ(I)=0.D0
      WRITE(II,2001) FLUXDX(I),FLUXDY(I),FLUXDZ(I)
   20 CONTINUE
      WRITE(II,1100) IND
C     
CE    JEDINICNI FLUKS X,Y,Z
      WRITE(II,1100) IND
	WRITE(II,1100) ITYP
	WRITE(II,5003) NASLOV
      WRITE(II,5016) KOR
 5019 FORMAT(
     1   '         2         1         1         9         2         1'/
     1   '         1         1',I10/
     1   E13.5)
 5016 FORMAT('MASS FLUX PER UNIT TIME AND SURFACE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5019) KOR,VREME
   	DO 30 I=1,NPT
      WRITE(II,1000) I
	IF(DABS(FLUXDXU(I)).LT.1.D-15) FLUXDXU(I)=0.D0
	IF(DABS(FLUXDYU(I)).LT.1.D-15) FLUXDYU(I)=0.D0
	IF(DABS(FLUXDZU(I)).LT.1.D-15) FLUXDZU(I)=0.D0
      WRITE(II,2001) FLUXDXU(I),FLUXDYU(I),FLUXDZU(I)
   30 CONTINUE
      WRITE(II,1100) IND
C
C	DIFFUSION COEFFICIENT
      WRITE(II,1100) IND
	WRITE(II,1100) ITYP
	WRITE(II,5003) NASLOV
      WRITE(II,5036) KOR
 5039 FORMAT(
     1   '         2         1         1        14         2         1'/
     1   '         1         1',I10/
     1   E13.5)
 5036 FORMAT('DIFFUSION COEFFICIENT'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5039) KOR,VREME
	DO 50 I=1,NPT
      WRITE(II,1000) I
      WRITE(II,2001) DIFFUSV(1,I),DIFFUSV(2,I),0
   50 CONTINUE
      WRITE(II,1100) IND      
C
C	COVERED RELATIVE AREA
	IF(IABSORB.EQ.0) RETURN
      WRITE(II,1100) IND
	WRITE(II,1100) ITYP
	WRITE(II,5003) NASLOV
      WRITE(II,5026) KOR
 5029 FORMAT(
     1   '         2         1         1        10         2         1'/
     1   '         1         1',I10/
     1   E13.5)
 5026 FORMAT('COVERED RELATIVE AREA'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5029) KOR,VREME
   	DO 40 NN=1,NXTOT+1 
      NODE=NBNODES(NN)
      WRITE(II,1000) NODE
      WRITE(II,2001) ENREL(NN)
   40 CONTINUE
      WRITE(II,1100) IND
C
      RETURN
      END
C=======================================================================

C=======================================================================
      SUBROUTINE PRKOR(NKDT,DTDT,VDT,VREME,NNDT,NDT,IND)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      CHARACTER*130 ACOZ
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS 
      DIMENSION NKDT(*),DTDT(*),VDT(*)
C
      IF(IND.LT.0)RETURN

      IF(IND.EQ.1) GO TO 999
      CALL ISPITA (ACOZ)
      KARTI=KARTIC
      IF(INDFOR.EQ.1)
     1READ(1,*) (NKDT(K),K=1,NNDT)
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1114) (NKDT(K),K=1,NNDT)
 1114 FORMAT(9I10)
      CALL ISPITA (ACOZ)
      IF(INDFOR.EQ.1)
     1READ(1,*) (DTDT(I),I=1,NNDT)
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1015) (DTDT(I),I=1,NNDT)
 1015 FORMAT(9E10.4)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      CALL WBROJK(KARTI,0)
      IF(ISRPS.EQ.0)
     1WRITE(3,2000)
      IF(ISRPS.EQ.1)
     1WRITE(3,6000)
      DO 197 I=1,NNDT
      WRITE(3,5010) I,NKDT(I),DTDT(I)
  197 CONTINUE
      ENDIF
      NDT=0
      DO 186 I=1,NNDT
  186 NDT=NDT+NKDT(I)
      RETURN
  999 K=0
      VREME=0.
      DO 184 I=1,NNDT
      DO 184 J=1,NKDT(I)
      K=K+1
      VREME=VREME+DTDT(I)
  184 VDT(K)=DTDT(I)
C      VDT(K)=VREME
C  184 CONTINUE
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2020) NDT,VREME
      IF(ISRPS.EQ.1)
     1WRITE(3,6020) NDT,VREME
      ENDIF
      RETURN
 5010 FORMAT(11X,I10,10X,I10,10X,E10.4)
 2000 FORMAT(6X,
     1'P O D A C I   O   V R E M E N S K I M   K O R A C I M A'/
     16X,55('-')///11X,
     2' PERIOD RESAVANJA       BROJ VREM. KORAKA         VREM. KORAK')
 2020 FORMAT(' ',11X,60('-')/11X,' BROJ VREMENSKIH KORAKA NDT =',I4,2X,
     1'UKUPNO VREME =',1PD12.5)
 6000 FORMAT(6X,
     1'D A T A   F O R   T I M E   S T E P S'/
     16X,37('-')///11X,
     2' SOLUTION PERIOD        NUM. OF TIME STEPS         TIME STEP')
 6020 FORMAT(' ',11X,60('-')/11X,' TOTAL NUMBER OF TIME STEPS    NDT =',
     1 I10,4X,'TOTAL TIME =',E12.5)
      END
C=======================================================================

C=======================================================================
      SUBROUTINE PRINTE(IDT,ISKC,TCONS,TEMPV,FLUXDX,FLUXDY,
	1           NPT,VREME,KOR,ITER,LINTE,INDSC,IFORM,NTCONS)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
C
      DIMENSION IDT(*),TCONS(*),TEMPV(*),N4(4),T4(4),ISKC(*)
	DIMENSION FLUXDX(NPT),FLUXDY(NPT),FLX(2),FLY(2)
C
      IF(ISRPS.EQ.0)
     1WRITE(3,2000) KOR,VREME
      IF(ISRPS.EQ.1)
     1WRITE(3,6000) KOR,VREME
      IF(LINTE.EQ.0) GO TO 60
      IF(ISRPS.EQ.0)
     1WRITE(3,2003) ITER
      IF(ISRPS.EQ.1)
     1WRITE(3,6003) ITER
   60 IF(ISRPS.EQ.0)
     1WRITE(3,2001)
      IF(ISRPS.EQ.1)
     1WRITE(3,6001)
      KG = 0
C      JEDN = 0
C      MILOS-KORIGOVANO 19 MARTA,09
C     
C     SET TO ZERO SMALL VALUES
      DO I=1,NPT
       IF(DABS(TEMPV(I)).LT.1.D-15) TEMPV(I)=0.D0
      ENDDO
   20 DO 50 I = 1,4
   55 KG = KG +1
      IF(KG.GT.NPT) GO TO 100
      IF(INDSC.EQ.0) GO TO 56
      IF(ISKC(KG).EQ.0) GO TO 55
   56 N4(I) = KG
      IF(IDT(KG).LE.0.AND.NTCONS.GT.0) GO TO 30
C     JEDN = JEDN + 1
C      JJ=IDT(KG)
       T4(I) = TEMPV(KG)
C      T4(I) = TEMPV(JEDN)
      GO TO 50
   30 CONTINUE
       IF(NTCONS.NE.0) T4(I) = TCONS(KG)
   50 CONTINUE
  100 I = I - 1
      IF(IFORM.EQ.1) GO TO 88
      WRITE(3,2002) (N4(J),T4(J),J=1,I)
 2002 FORMAT(4(I8,4X,D13.5))
      GO TO 77
   88 WRITE(3,2153) (N4(J),T4(J),J=1,I)
 2153 FORMAT(4(I8,4X,F10.3))
   77 IF(KG.LT.NPT) GO TO 20
C
C     MASS FLUX OVER TIME STEP AT NODES
C
      INDFLUX=0
      IF(INFLUX.EQ.0) RETURN
      WRITE(3,6010)
      KG = 0
  120 DO 150 I = 1,2
      KG = KG +1
      IF(KG.GT.NPT) GO TO 300
      N4(I) = KG
      FLX(I)=FLUXDX(KG)
	FLY(I)=FLUXDY(KG)
  150 CONTINUE
  300 I = I - 1
      WRITE(3,2012) ((N4(J),FLX(J),FLY(J)),J=1,I)
 2012 FORMAT(2(I8,4X,D13.5,2X,D13.5))
      IF(KG.LT.NPT) GO TO 120
C
      RETURN
 2000 FORMAT(//////'1'/' K O R A K  BROJ =',I6,25X,'V R E M E =',1PD12.5
     1///'               T   E   M   P   E   R   A   T   U   R   E'/)
 2003 FORMAT(/' BROJ ITERACIJA ............................. ITER =',I5)
 2001 FORMAT(/'                  C V O R N E    T E M P E R A T U R E'//
     1' CVOR  TEMPERATURA CVOR  TEMPERATURA CVOR  TEMPERATURA CVOR  TEMP
     1ERATURA'/' BROJ',3(14X,'BROJ'))
 6000 FORMAT(///'1'/' S T E P  NUMBER =',I6,25X,'  T I M E =',1PD12.5
     1)
 6003 FORMAT(' NUMBER OF ITERATIONS ....................... ITER =',I5)
 6001 FORMAT(/'                 N O D A L    C O N C E N T R A T I O N S
     1'//
     1' NODE  CONCENTRAT',4X,'NODE  CONCENTRAT',3X,'NODE  CONCENTRAT',
     22X,' NODE CONCENTRAT')
6010  FORMAT(/'                N O D A L   M A S S   F L U X E S'/
     1' NODE',10X,'FLUX-X',12X,'FLUX-Y',7X,'NODE',7X,'FLUX-X',
     1        11X,'FLUX-Y') 
    
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE DARCYVELOC(IDT,IDARCYMA,TT1,NZADJ,ZADFM,CORD,VELOC,
     1 INODE,NZADP,indiffus,IHEAT,NDIMID)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT
      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON/DARCYCONV/ICONV,IDINF,GUSTF,IDIFUSE,LMATCONV,LMATDIF,
     1       NMATTCONV,NMATTDIF,maxPmatC,maxPmatD,LMATFUNC,LMATFUND,
     2       LNELFICT,MAXCONNP,MAXCONNP2
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON /EL2K09/NMAT2D,MAT2D,NE2D,NGAU2X,NGAU2Y,NP2DMX,
     1IPR2DC,IPTG2,N2DGU,MEL2D,IQE2,NBR2,NCV2,LM2(9),IDEL2(5),
     2NOD5(5),NND5,IELX2,NLM2,NTHIC,THIC
      COMMON /EL3K21/NMAT3D,MAT3D,NE3D,NGAUSX,NGAUSY,NGAUSZ,NP3DMX,
     1IPR3DC,IPTGA,N3DGU,MEL3D,IQE,NBRE,NCV,LM(21),IDEL(13),
     2NOD9(13),NND9,IELX,NLM
      COMMON/MAINIDT/NDIMIDT
      COMMON A(1)
C
      DIMENSION IDT(NDIMID,NPT),IDARCYMA(NPT),TT1(JEDN),INODE(NPT)
      DIMENSION NZADJ(3,NZADP),ZADFM(NZADP),CORD(NPT,3),VELOC(3,NPT)
C
      IF(ICONV.EQ.0) RETURN
C     
C     SET TO ZERO SMALL VALUES
C
      DO NODE=1,NPT
        DO J=1,2
          II=IDT(J,NODE)
          IF(II.GT.0) THEN
            IF(DABS(TT1(II)).LT.1.D-15) TT1(II)=0.D0
          ENDIF
        ENDDO
      ENDDO
C
C     VELOCITIES WITHIN LINE AND CONTINUUM ELEMENTS  
C
      CALL ICLEAR(INODE,NPT)
      CALL CLEAR(VELOC,3*NPT)
      DO 280 NGE = 1,NGET
        NETIP    = NELEDAT(NGE,1)
        NET      = NELEDAT(NGE,2)
        MAT2D3DC = NELEDAT(NGE,5)  
        LNEL     = NELEDAT(NGE,7)
       
        IF(NETIP.EQ.1.OR.NETIP.EQ.4) THEN   ! 1D
          ICONECTIV = NELEDAT(NGE,10)
          LDARCYD   = NELEDAT(NGE,14)
          LDARCYMI  = NELEDAT(NGE,15)
          LEMODULUS = NELEDAT(NGE,29)
          LDELTAE   = NELEDAT(NGE,30)
          LELFLUX   = NELEDAT(NGE,32)
          IDEFORM   = NELEDAT(NGE,33)
          IF(ICONECTIV.EQ.1) GO TO 280
	    CALL VELOCITIES1D(IDT,IDARCYMA,TT1,NZADJ,ZADFM,CORD,A(LNEL),
     1A(LDARCYD),A(LDARCYMI),A(LEMODULUS),A(LDELTAE),A(LELFLUX),VELOC,
     2 INODE,NPT,NET,JEDN,NZADP,VREME,NETIP,IDEFORM,NDIMIDT)
        ELSE IF (NETIP.EQ.2) THEN           ! 2D
          NDES   = NP2DMX*NDIMIDT
          LSKE   = LMAX
          NE2D   = NET
          LTHI2D = NELEDAT(NGE,10)
          CALL VELOCITIES2D(IDT,CORD,A(LNEL),A(LSKE),A(LTHI2D),TT1,
     1    VELOC,INODE,A(LMATCONV),A(LMATFUNC),NZADJ,ZADFM,NZADP,NDES,
     2    MAT2D3DC,NDIMID)
        
        ELSE IF (NETIP.EQ.3) THEN           ! 3D
          NDES = NP3DMX*NDIMIDT
          LSKE = LMAX
          NE3D = NET
          CALL VELOCITIES3D(IDT,CORD,A(LNEL),A(LSKE),TT1,VELOC,INODE,
     1 A(LMATCONV),A(LMATFUNC),NZADJ,ZADFM,NZADP,NDES,MAT2D3DC,NDIMID) 
        ENDIF
  280 CONTINUE
C
      DO IN = 1,NPT
        IF(INODE(IN).GT.1) THEN
          AIND = INODE(IN)
          DO J = 1,3
            VELOC(J,IN) = VELOC(J,IN) / AIND
          ENDDO
        ENDIF
      ENDDO
C    
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE PRINTEDARCY(IDT,IDARCYMA,TT1,NZADJ,ZADFM,CORD,VELOC,
     1 NZADP,indiffus,IHEAT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT
      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON/DARCYCONV/ICONV,IDINF,GUSTF,IDIFUSE,LMATCONV,LMATDIF,
     1       NMATTCONV,NMATTDIF,maxPmatC,maxPmatD,LMATFUNC,LMATFUND,
     2       LNELFICT,MAXCONNP,MAXCONNP2
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON /EL2K09/NMAT2D,MAT2D,NE2D,NGAU2X,NGAU2Y,NP2DMX,
     1IPR2DC,IPTG2,N2DGU,MEL2D,IQE2,NBR2,NCV2,LM2(9),IDEL2(5),
     2NOD5(5),NND5,IELX2,NLM2,NTHIC,THIC
      COMMON /EL3K21/NMAT3D,MAT3D,NE3D,NGAUSX,NGAUSY,NGAUSZ,NP3DMX,
     1IPR3DC,IPTGA,N3DGU,MEL3D,IQE,NBRE,NCV,LM(21),IDEL(13),
     2NOD9(13),NND9,IELX,NLM
      COMMON/MAINIDT/NDIMIDT
      COMMON A(1)
C
      DIMENSION IDT(NDIMIDT,NPT),IDARCYMA(NPT),TT1(JEDN),TT(2)
      DIMENSION NZADJ(3,NZADP),ZADFM(NZADP),CORD(NPT,3),VELOC(3,NPT)
C
      WRITE(3,6000) KOR,VREME
      IF(LINTE.GT.0)WRITE(3,6001) ITER 
      WRITE(3,6003)  
C     
C     SET TO ZERO SMALL VALUES
C
      DO NODE=1,NPT
        DO J=1,2
          II=IDT(J,NODE)
          IF(II.GT.0) THEN
            IF(DABS(TT1(II)).LT.1.D-15) TT1(II)=0.D0
          ENDIF
        ENDDO
      ENDDO
C
      DO 200 NODE=1,NPT
      DO 100 I=1,2
        TT(I)=0.D0
        II=IDT(I,NODE)
        IF(II.GT.0) THEN
           TT(I)=TT1(II)
        ELSEIF ((IDARCYMA(NODE).EQ.1.AND.I.EQ.1).OR.
     1    (I.EQ.2.AND.(IDT(2,NODE).EQ.0.AND.(indiffus.EQ.1.OR.IHEAT.EQ.1
     2          )))) THEN
           IF(NZADP.EQ.0) GO TO 100
	     DO KK=1,NZADP
	       NJ=NZADJ(1,KK)
	       IF(NJ.EQ.NODE) THEN
	         IDOF=NZADJ(2,KK)
               IF(IDOF.EQ.I) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                     IND)
                  IF(IND.NE.0) THEN    
                     WRITE(3,6015) NF,VREME
                     STOP
                  ENDIF
                  TT(I)=FT*FAK
                  GO TO 100
               ENDIF
	       ENDIF
	     ENDDO
	   ENDIF
  100 CONTINUE 
      WRITE(3,2010) NODE,TT(1),TT(2) 
  200 CONTINUE
C
      IF(ICONV.EQ.0) RETURN
C
C     VELOCITIES WITHIN LINE AND CONTINUUM ELEMENTS  
C
      DO 280 NGE = 1,NGET
        NETIP    = NELEDAT(NGE,1)
        NET      = NELEDAT(NGE,2)
        MAT2D3DC = NELEDAT(NGE,5)  
        LNEL     = NELEDAT(NGE,7)
        LELFLUX  = NELEDAT(NGE,32)
       
        IF(NETIP.EQ.1.OR.NETIP.EQ.4) THEN   ! 1D
          ICONECTIV = NELEDAT(NGE,10)
          LDARCYD   = NELEDAT(NGE,14)
          LDARCYMI  = NELEDAT(NGE,15)
          LEMODULUS = NELEDAT(NGE,29)
          LDELTAE   = NELEDAT(NGE,30)
          LELFLUX   = NELEDAT(NGE,32)
          IDEFORM   = NELEDAT(NGE,33)
          IF(ICONECTIV.EQ.1) GO TO 280
	    CALL PRINTEL1D(IDT,IDARCYMA,TT1,NZADJ,ZADFM,CORD,A(LNEL),
     1 A(LDARCYD),A(LDARCYMI),A(LEMODULUS),A(LDELTAE),A(LELFLUX),NPT,
     2 NET,JEDN,NZADP,VREME,NETIP,IDEFORM,NDIMIDT)
        ELSE IF (NETIP.EQ.2) THEN           ! 2D
          NDES   = NP2DMX*NDIMIDT
          LSKE   = LMAX
          NE2D   = NET
          LTHI2D = NELEDAT(NGE,10)
    !      CALL VELOCITIES2D(IDT,CORD,A(LNEL),A(LSKE),A(LTHI2D),TT1,VELOC
    ! 1,INODE,A(LMATCONV),A(LMATFUNC),NZADJ,ZADFM,NZADP,NDES,MAT2D3DC)
        
        ELSE IF (NETIP.EQ.3) THEN           ! 3D
          NDES = NP3DMX*NDIMIDT
          LSKE = LMAX
          NE3D = NET
    !      CALL VELOCITIES3D(IDT,CORD,A(LNEL),A(LSKE),TT1,VELOC,INODE,
    ! 1 A(LMATCONV),A(LMATFUNC),NZADJ,ZADFM,NZADP,NDES,MAT2D3DC) 
        ENDIF
        
  280 CONTINUE
C
 6000 FORMAT(///'1'/' S T E P  NUMBER =',I6,25X,'  T I M E =',1PD12.5
     1)
 6001 FORMAT(' NUMBER OF ITERATIONS ....................... ITER =',I5)
 6003 FORMAT(/'  N O D A L   P R E S S U R E S  A N D  ',
     1            'C O N C E N T R A T I O N S/ T E M P E R A T U R E S'
     2//5X,' NODE        PRESSURE',6X,'CONCENTRATION/TEMPERATURE')
 2010 FORMAT(I10,5X,1PD12.4,5X,1PD12.4)
 6015 FORMAT(//1X,'CURVE ARGUMENT IS OUT OF RANGE'/
     11X,'CURVE TIME-PRESCRIBED VALUE  No. =',I5/
     11X,'ARGUMENT TIME,  VREME =',1PD12.4)  
    
      RETURN
      END
C=======================================================================
C
C======================================================================
	SUBROUTINE PRINTEL1D(IDT,IDARCYMA,TT1,NZADJ,ZADFM,CORD,NEL,DARCYD,
     1 DARCYMI,EMODULUS,DELTAE,ELFLUX,NPT,NET,JEDN,NZADP,VREME,NETIP,
     2 IDEFORM,NDIMIDT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
      COMMON A(1) 
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT   
      DIMENSION IDT(NDIMIDT,NPT),IDARCYMA(NPT),TT1(JEDN),NZADJ(3,NZADP),
     1          ZADFM(NZADP),CORD(NPT,3),NEL(NET,2),DARCYD(2,NET),
     2          DARCYMI(NET),EMODULUS(NET),DELTAE(NET),ELFLUX(2,NET)
      DIMENSION CORDL(3,2),TT(2),EL0(3),VELE(3)
      
      PI    = 4.*DATAN(1.D0)
      PI4   = PI/4.
      COEFF = PI/128.
C     
      IF      (NETIP.EQ.1) THEN
        WRITE(3,2510)
      ELSE IF (NETIP.EQ.4) THEN
        WRITE(3,2520)
      ENDIF
C      
 2510 FORMAT(/' V E L O C I T I E S AND F L U X E S OF E L E M E N T S'/
     1  ' ELEMENT  NODE1  NODE2     VELOCITY(MICRON/S)  FLUX(MICRON**3/'
     2  ,'S)',3X,'NODAL PRESSURES'/
     2  24X,  'POSITIVE VEL AND FLUX IS FROM NODE1 TO NODE2')

 2520 FORMAT(/' V E L O C I T I E S AND F L U X E S OF E L E M E N T S'/
     1  ' ELEMENT  NODE1  NODE2  VEL1(MICRON/S) VEL2(MICRON/S)',
     2  ' FLUX1(MICRON**3/S) FLUX2(MICRON**3/S)',3X,'NODAL PRESSURES'/
     2  24X,  'POSITIVE VEL AND FLUX IS FROM NODE1 TO NODE2')
C
      DO 200 NLM=1,NET
        N1=NEL(NLM,1)
        N2=NEL(NLM,2)
        DO I=1,3
          CORDL(I,1)=CORD(N1,I)
          CORDL(I,2)=CORD(N2,I)
        ENDDO  
        ELL=0.D0
        DO I=1,3
          DX=CORDL(I,2)-CORDL(I,1)
          EL0(I)=DX
          ELL= ELL+DX*DX
        ENDDO
        ELL=DSQRT(ELL)
        DO I=1,3
          EL0(I)=EL0(I)/ELL
        ENDDO
      
        DO 100 I=1,2
          TT(I)=0.D0
          NODE=NEL(NLM,I)
          II=IDT(1,NODE)
          IF(II.GT.0) THEN
            TT(I)=TT1(II)
          ELSEIF (IDARCYMA(NODE).EQ.1) THEN
            IF(NZADP.EQ.0) GO TO 100
	      DO KK=1,NZADP
	        NJ=NZADJ(1,KK)
	        IF(NJ.EQ.NODE) THEN
	          IDOF=NZADJ(2,KK)
                IF(IDOF.EQ.1) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                      IND)
                  IF(IND.NE.0) THEN    
                    WRITE(3,6015) NF,VREME
                    STOP
                  ENDIF
                  TT(I)=FT*FAK
                  GO TO 100
                ENDIF
	        ENDIF
	      ENDDO
	    ENDIF
  100   CONTINUE 
C       
        IF(NETIP.EQ.1) THEN             ! Hagen-Poiseuille
          DIAM = 0.5*(DARCYD(1,NLM)+DARCYD(2,NLM))
          AREA = PI4*DIAM*DIAM
          AMI  = DARCYMI(NLM)
          AK   = COEFF*DIAM**4/AMI        
          QQ   = (TT(1)-TT(2))*AK/ELL
          VELOCITY = QQ/AREA
        
          DO I=1,3
            VELE(I)=VELOCITY*EL0(I)
          ENDDO
        
          WRITE(3,2511)NLM,N1,N2,VELOCITY,QQ,TT(1),TT(2)
        ELSE                            ! Navier-Stokes
          RR1   = 0.5 * DARCYD(1,NLM)
          RR2   = 0.5 * DARCYD(2,NLM)
          IF(IDEFORM.EQ.1) THEN
            EEE     = EMODULUS(NLM)
            DELTAE0 = DELTAE(NLM)
            AKEE    = 0.75/(DELTAE0*EEE)
            RR1     = RR1/(1.-RR1*AKEE*TT(1))
            RR2     = RR2/(1.-RR2*AKEE*TT(2))
          ENDIF
          
          AREA1 = PI*RR1*RR1
          AREA2 = PI*RR2*RR2      
          QQ1   = ELFLUX(1,NLM)
          QQ2   = ELFLUX(2,NLM)
          VEL1  = QQ1/AREA1
          VEL2  = QQ1/AREA2
          
          WRITE(3,2521)NLM,N1,N2,VEL1,VEL1,QQ1,QQ2,TT(1),TT(2)
        ENDIF
  200 CONTINUE
C
 2511 FORMAT(I6,2I6,5X,D13.5,5X,D13.5,5X,2D13.5)
 2521 FORMAT(I6,2I6,5X,2D13.5,5X,2D13.5,5X,2D13.5) 
 
 6015 FORMAT(//1X,'CURVE ARGUMENT IS OUT OF RANGE'/
     11X,'CURVE TIME-PRESCRIBED VALUE  No. =',I5/
     11X,'ARGUMENT TIME,  VREME =',1PD12.4)
     
      RETURN
      END
C=======================================================================
C       
C======================================================================= 
      SUBROUTINE PRINTEL1DUNV(IDT,IDARCYMA,TT1TOT,NZADJ,ZADFM,CORD,NEL,
     1  DARCYD,DARCYMI,EMODULUS,DELTAE,ELFLUX,NPT,NET,JEDN,NZADP,VREME,
     2  NASLOV,IUNV,KOR,NETIP,IDEFORM,DIAMTT,NDIMIDT)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C
C
C
      COMMON A(1) 
      CHARACTER*1 NASLOV(80)
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT   
      DIMENSION IDT(NDIMIDT,NPT),IDARCYMA(NPT),TT1TOT(NDIMIDT,NPT),
     1          NZADJ(3,NZADP),
     1          ZADFM(NZADP),CORD(NPT,3),NEL(NET,2),DARCYD(2,NET),
     2          DARCYMI(NET),EMODULUS(NET),DELTAE(NET),ELFLUX(2,NET)
      DIMENSION CORDL(3,2),TT(2),EL0(3),VELE1(3),VELE2(3),DIAMTT(2,NET)
      
      PI    = 4.*DATAN(1.D0)
      PI4   = PI/4.
      COEFF = PI/128.     
C
C     ELEM VELOCITIES
C
      IND  = -1
      NC   =  1
      ITYP = 57
      WRITE(IUNV,1100) IND
      WRITE(IUNV,1100) ITYP
      WRITE(IUNV,5003) NASLOV
      WRITE(IUNV,7004) KOR
 7004 FORMAT('BRZINE PO ELEMENTU'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(IUNV,7008) KOR,VREME
 7008 FORMAT(
     1   '         2         1         1       111         2         3'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO 200 NLM=1,NET
        N1=NEL(NLM,1)
        N2=NEL(NLM,2)
        DO I=1,3
          CORDL(I,1)=CORD(N1,I)
          CORDL(I,2)=CORD(N2,I)
        ENDDO  
        ELL=0.D0
        DO I=1,3
          DX=CORDL(I,2)-CORDL(I,1)
          EL0(I)=DX
          ELL= ELL+DX*DX
        ENDDO
        ELL=DSQRT(ELL)
        DO I=1,3
          EL0(I)=EL0(I)/ELL
        ENDDO
      
        DO 100 I=1,2
          TT(I)=0.D0
          NODE=NEL(NLM,I)
          II=IDT(1,NODE)
          IF(II.GT.0) THEN
            TT(I)=TT1TOT(1,NODE)
          ELSEIF (IDARCYMA(NODE).EQ.1) THEN
            IF(NZADP.EQ.0) GO TO 100
	      DO KK=1,NZADP
	        NJ=NZADJ(1,KK)
	        IF(NJ.EQ.NODE) THEN
	          IDOF=NZADJ(2,KK)
                IF(IDOF.EQ.1) THEN
                  NF=NZADJ(3,KK)
                  FAK = ZADFM(KK)
                  CALL TABF(A(LTABFT),A(LNTFT),NF,NTABFT,VREME,FT,NTMX,
     1                      INDD)
                  TT(I)=FT*FAK
                  GO TO 100
                ENDIF
	        ENDIF
	      ENDDO
	    ENDIF
  100   CONTINUE 
C
        RR1   = 0.5 * DARCYD(1,NLM)
        RR2   = 0.5 * DARCYD(2,NLM)
        IF(IDEFORM.EQ.1) THEN
          EEE     = EMODULUS(NLM)
          DELTAE0 = DELTAE(NLM)
          AKEE    = 0.75/(DELTAE0*EEE)
          RR1     = RR1/(1.-RR1*AKEE*TT(1))
          RR2     = RR2/(1.-RR2*AKEE*TT(2))
        ENDIF
        DIAMTT(1,NLM) = 2.0 * RR1
        DIAMTT(2,NLM) = 2.0 * RR2
        AREA1 = PI*RR1*RR1
        AREA2 = PI*RR2*RR2
        
        IF(NETIP.EQ.1) THEN             ! Hagen-Poiseuille
          DIAM  = RR1+RR2
          AREA  = PI4*DIAM*DIAM
          AMI   = DARCYMI(NLM)
          AK    = COEFF*DIAM**4/AMI        
          QQ    = (TT(1)-TT(2))*AK/ELL
          VEL1  = QQ/AREA1 
          VEL2  = QQ/AREA2
        ELSE                            ! Navier-Stokes      
          QQ1   = ELFLUX(1,NLM)
          QQ2   = ELFLUX(2,NLM)
          VEL1  = QQ1/AREA1
          VEL2  = QQ1/AREA2
        ENDIF
        
        DO I=1,3
          VELE1(I)=VEL1*EL0(I)
          VELE2(I)=VEL2*EL0(I)
        ENDDO
        
        WRITE(IUNV,1000) NLM !, 1, 2, 3
        WRITE(IUNV,3000) VELE1(1),VELE1(2),VELE1(3)
        WRITE(IUNV,3000) VELE2(1),VELE2(2),VELE2(3)
  200 CONTINUE
C
      WRITE(IUNV,1100) IND
C
C     ELEM FLUXES
C
      IF(NETIP.EQ.4) THEN    !Samo za Navier-Stokes
      
      IND  = -1
      NC   =  1
      ITYP = 57
      WRITE(IUNV,1100) IND
      WRITE(IUNV,1100) ITYP
      WRITE(IUNV,5003) NASLOV
      WRITE(IUNV,8004) KOR
 8004 FORMAT('FLUXEVI PO ELEMENTU'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(IUNV,8008) KOR,VREME
 8008 FORMAT(
     1   '         2         1         1       112         2         3'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO 300 NLM=1,NET
        N1=NEL(NLM,1)
        N2=NEL(NLM,2)
        DO I=1,3
          CORDL(I,1)=CORD(N1,I)
          CORDL(I,2)=CORD(N2,I)
        ENDDO  
        ELL=0.D0
        DO I=1,3
          DX=CORDL(I,2)-CORDL(I,1)
          EL0(I)=DX
          ELL= ELL+DX*DX
        ENDDO
        ELL=DSQRT(ELL)
        DO I=1,3
          EL0(I)=EL0(I)/ELL
        ENDDO
C
        QQ1 = ELFLUX(1,NLM)
        QQ2 = ELFLUX(2,NLM)
        
        DO I=1,3
          VELE1(I)=QQ1*EL0(I)
          VELE2(I)=QQ2*EL0(I)
        ENDDO
        
        WRITE(IUNV,1000) NLM !, 1, 2, 3
        WRITE(IUNV,3000) VELE1(1),VELE1(2),VELE1(3)
        WRITE(IUNV,3000) VELE2(1),VELE2(2),VELE2(3)
  300 CONTINUE
C
      WRITE(IUNV,1100) IND
      ENDIF
C
C     ELEMENT DAIMETERS
C      
      IND  = -1
      NC   =  1
      ITYP = 57
      WRITE(IUNV,1100) IND
      WRITE(IUNV,1100) ITYP
      WRITE(IUNV,5003) NASLOV
      WRITE(IUNV,9004) KOR
 9004 FORMAT('PRECNICI PO ELEMENTU'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(IUNV,9008) KOR,VREME
 9008 FORMAT(
     1   '         2         1         1       113         2         3'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO 400 NLM=1,NET
C                
        WRITE(IUNV,1000) NLM !, 1, 2, 3
        WRITE(IUNV,3000) DIAMTT(1,NLM)
        WRITE(IUNV,3000) DIAMTT(2,NLM)
  400 CONTINUE
C
      WRITE(IUNV,1100) IND
C
 1000 FORMAT(I10)
 1001 FORMAT(4I10)
 1100 FORMAT(I6)
 2000 FORMAT(E15.7)
 3000 FORMAT(3E15.7)
 5003 FORMAT(80A1)
C    
      RETURN
      END
C=============================================================================
C
C=============================================================================
      SUBROUTINE UCVRFN
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      CHARACTER*130 ACOZ
      COMMON A(17000)
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON /EFTREP/ NTABFT,MAXTFT,LNTFT,LTABFT
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
      COMMON /SRPSKI/ ISRPS
      CALL ISPITA (ACOZ)
      IF(INDFOR.EQ.1)
     1READ(1,*) NTABFT,MAXTFT
      IF(INDFOR.EQ.2)
     1READ(ACOZ,1000) NTABFT,MAXTFT
 1000 FORMAT(14I5)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      CALL WBROJK(KARTIC,1)
      IF(ISRPS.EQ.0)
     1WRITE(3,2000) NTABFT,MAXTFT
      IF(ISRPS.EQ.1)
     1WRITE(3,6000) NTABFT,MAXTFT
      ENDIF
      IF(NTABFT.EQ.0) RETURN
      TMAX = VREME
      IBR=0
      ITMAX=0
      LTABFT = LMAX
      LNTFT = LTABFT + 2*NTABFT*MAXTFT
      LMAX = LNTFT + NTABFT
      IF(LMAX.GT.NTOTA) CALL ERROR(1)
      IF(NULAZ.EQ.1.OR.NULAZ.EQ.3) THEN
      IF(ISRPS.EQ.0)
     1WRITE(3,2010)
      IF(ISRPS.EQ.1)
     1WRITE(3,6010)
      ENDIF
      CALL ULTABF(A(LNTFT),A(LTABFT),NTABFT,MAXTFT,IBR,IMAX,
     1ITMAX,TFMX,TMAX,1)
      IF(IBR.EQ.0.OR.ITMAX.EQ.1) GO TO 20
      IF(ISRPS.EQ.0)
     1WRITE(3,2020)
      IF(ISRPS.EQ.1)
     1WRITE(3,6020)
      IF(ISRPS.EQ.0)
     1WRITE(3,2030)IBR,IMAX,MAXTFT
      IF(ISRPS.EQ.1)
     1WRITE(3,6030)IBR,IMAX,MAXTFT
      STOP
   20 IF(ITMAX.EQ.0) RETURN
      IF(ISRPS.EQ.0)
     1WRITE(3,2020)
      IF(ISRPS.EQ.1)
     1WRITE(3,6020)
      IF(ISRPS.EQ.0)
     1WRITE(3,2040)IBR,TFMX,TMAX
      IF(ISRPS.EQ.1)
     1WRITE(3,6040)IBR,TFMX,TMAX
      STOP
 2000 FORMAT(6X,
     1'P O D A C I    O    V R E M E N S K I M     F U N K C I J A M A'/
     16X,63('-')///
     211X,'BROJ RAZLICITIH VREMENSKIH FUNKCIJA ........... NTABFT =',I5/
     216X,'EQ.0; NEMA VREMENSKIH FUNKCIJA'///
     311X,'MAX. BROJ TACAKA ZA DEF. VREM. FUNKCIJA ....... MAXTFT =',I5/
     216X,'EQ.0; NEMA VREMENSKIH FUNKCIJA'/
     316X,'EQ.1; VREMENSKE FUNKCIJE SU KONSTANTNE'/
     316X,'GT.1; VREMENSKE FUNKCIJE SU PROMENLJIVE')
 2010 FORMAT(//////6X,'V R E M E N S K E    F U N K C I J E'/6X,36('-'))
 2020 FORMAT(///' GRESKA U ULAZNIM PODACIMA ZA VREMENSKE FUNKCIJE')
 2030 FORMAT(/' FUNKCIJA BR. =',I5/' UCITAN BROJ TACAKA, IMAX=',I5/
     1' ZADATI MAKSIMALNI BROJ TACAKA ZA KRIVU , MAXTFT=',I5)
 2040 FORMAT(///' VREMENSKA FUNKCIJA NIJE DEFINISANA U CELOM INREVALU'/
     1/' FUNKCIJA BR. =',I5/' INTERVAL DEFINISANOSTI =',1PD12.5/
     2' VREMENSKI INTERVAL INTEGRACIJE, TMAX =',1PD12.5)
 6000 FORMAT(6X,
     1'D A T A    F O R    T I M E    F U N C T I O N S'/
     16X,48('-')///
     211X,'NUMBER OF DIFFERENT TIME FUNCTIONS ............ NTABFT =',I5/
     216X,'EQ.0; THERE ARE NO TIME FUNCTIONS'///
     311X,'MAX. NUM. OF POINTS FOR DEFINITION OF TIME FUN. MAXTFT =',I5/
     216X,'EQ.0; THERE ARE NO TIME FUNCTIONS'/
     316X,'EQ.1; TIME FUNCTIONS ARE CONSTANT'/
     316X,'GT.1; TIME FUNCTIONS ARE VARIABLE')
 6010 FORMAT(//////6X,'T I M E    F U N C T I O N S'/6X,28('-'))
 6020 FORMAT(///' ERROR IN INPUT DATA FOR TIME FUNCTIONS')
 6030 FORMAT(/' FUNKCIJA BR. =',I5/' UCITAN BROJ TACAKA, IMAX=',I5/
     1' ZADATI MAKSIMALNI BROJ TACAKA ZA KRIVU , MAXTFT=',I5)
 6040 FORMAT(///' VREMENSKA FUNKCIJA NIJE DEFINISANA U CELOM INREVALU'/
     1/' FUNKCIJA BR. =',I5/' INTERVAL DEFINISANOSTI =',1PD12.5/
     2' VREMENSKI INTERVAL INTEGRACIJE, TMAX =',1PD12.5)
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE ERROR(I)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON /TEMPGL/ NPT,NGET,NMATT,NSTAC,MAXIT,NDT,NTCONS,
     1NET,NGE,JEDN,DT,TMAX,VREME,NPOC,NWK,NPRINT,LINTE,
     2KONF,INDSK,INDF,KOR,NTOTA,ITER,INDSC,INTEB,INDAX,IANIZ,NQE,IZIP,
     3ITOR,INDVEL,INDFL
      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      GO TO (1,2,3),I
    1 WRITE(3,2009) LMAX,NTOTA
 2009 FORMAT(/1X,'UNSUFFICIENT DIMENSION OF BASIC VECTOR FOR DATA ENTRY
     1                         '/1X,'REQURED DIMENSION , LMAX=',I10/1X,'
     2AVAILABLE DIMENSION  , MTOT=',I10)
      STOP
    2 WRITE(3,2009) LMAX,NTOTA
      STOP
    3 WRITE(3,2009) LMAX,NTOTA
      STOP
      END
C=======================================================================

C=======================================================================
      SUBROUTINE CLEAR(A,N)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION A(*)
      DO 10 I=1,N
   10 A(I)=0.0D0
      RETURN
      END
C=======================================================================

C=======================================================================
      SUBROUTINE ICLEAR(IA,N)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION IA(*)
      DO 10 I=1,N
   10 IA(I)=0
      RETURN
      END
C=======================================================================

C=======================================================================
      SUBROUTINE ZBIR(A,N)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION A(N)
      AA=0.D0
      DO 10 I=1,N
      AA=AA+A(I)
 10   CONTINUE
      WRITE(3,*) 'DESNA STRANA=',AA
 5000 FORMAT(F10.4)
      END
C=======================================================================
C=======================================================================
      SUBROUTINE ISPITA(ACOZ)
CE.    P R O G R A M
CE.        TO TEST INPUT CARD
      CHARACTER*130 ACOZ
      COMMON /BROJUK/ KARTIC,INDFOR,NULAZ
   10 KARTIC = KARTIC + 1
      READ(1,1000) ACOZ
      IF(ACOZ(1:2).EQ.'C '.OR.ACOZ(1:2).EQ.'C*'.OR.ACOZ(1:2).EQ.'C-')
     1 GO TO 10
      IF(INDFOR.EQ.2) RETURN
      BACKSPACE 1
      RETURN
 1000 FORMAT(A130)
      END
C==========================================================================
C==========================================================================
      CHARACTER *4 FUNCTION  INTSTR (INT)
         CHARACTER *1 J,D,S,H
         J='0'
         D='0'
         S='0'
         H='0'

         NULA=ICHAR('0')

         IH=INT/1000
	 N1=INT-IH*1000
         IS=N1/100
         NN=N1-IS*100
         ID=NN/10
         IJ=MOD(NN,10)
         J=CHAR(IJ+NULA)
         D=CHAR(ID+NULA)
         S=CHAR(IS+NULA)
         H=CHAR(IH+NULA)
         INTSTR=H//S//D//J
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TKFORMMULTIMOL(IDT,IDTV,TT1TOT,TT1TOTP,TT1TOTC,
     1   IDTVCELL,TT1P,TT1C,TT1PM,TT1CM,NZADNODF,ZADATAM1,NZADJ,ZADATA1,
     2   IZADLOCALDI,IPIPENODV,IDLYMPHH,IDLYMPHC,INPUTLY,ZADALYMH1,
     3   NZADLY, NZADLYMPHMX,IACTIVE,NPT,NZADP,KOR,ITER,VREME,NDIMID,
     5   ILARGEVES,JEDNPRES,JEDNCONC,JEDNPMAX,JEDNCMAX,ISMEARED,
     6   NDIMTOTAL,NZADPMAX,NDIMCELL,MULTIMOL,MM,
     7   INDLYMPH,INDLYMPHH,INDLYMPHC)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON A(1)
C
      DIMENSION TT1TOT(4,NPT)
      DIMENSION TT1TOTP(MULTIMOL,2,NPT),TT1TOTC(MULTIMOL,7,NPT)
C
      DIMENSION IDT(NDIMID,NPT),IDTV(MULTIMOL,NDIMID,NPT),
     1  IDTVCELL(MULTIMOL,NDIMCELL,NPT),TT1P(JEDNPRES),TT1C(JEDNCONC),
     1  TT1PM(MULTIMOL,JEDNPMAX),TT1CM(MULTIMOL,JEDNCMAX),
     2  NZADNODF(MULTIMOL,3,NZADPMAX),ZADATAM1(MULTIMOL,NZADPMAX),
     3  NZADJ(3,NZADP),ZADATA1(NZADP),IZADLOCALDI(NDIMTOTAL,NPT),
     4  IPIPENODV(NPT),IACTIVE(4)
      DIMENSION IDLYMPHH(NPT),IDLYMPHC(MULTIMOL,NPT),
     1  INPUTLY(MULTIMOL,3,NZADLYMPHMX),ZADALYMH1(MULTIMOL,NZADLYMPHMX)
C
      CALL ICLEAR(IZADLOCALDI,NDIMTOTAL*NPT)
C
      IF(MULTIMOL.GT.1) GO TO 10
      IF(NZADP.GT.0) THEN
         DO KK=1,NZADP
            NODE=NZADJ(1,KK)
	      IDIR  = NZADJ(2,KK)
	      IDIRA = IABS(IDIR)
	      IF(IACTIVE(IDIR).EQ.1) THEN
	         IZADLOCALDI(IDIR,NODE)=KK
	      ENDIF      
	   ENDDO
	ENDIF
	GO TO 15
  10  CONTINUE
C
      IF(NZADP.GT.0) THEN
         DO KK=1,NZADP
            NODE=NZADNODF(MM,1,KK)
	      IDIR =NZADNODF(MM,2,KK)
	      IDIRA=IABS(IDIR)
	      IF(IACTIVE(IDIR).EQ.1) THEN
	         IZADLOCALDI(IDIR,NODE)=KK
	      ENDIF
	   ENDDO
	ENDIF		
	
   15 CONTINUE	
C
      DO 200 KID=1,4
         IF(IACTIVE(KID).EQ.0) GO TO 200
C
         KG=0   
   20    CONTINUE

   55    KG = KG + 1
         IF(KG.GT.NPT) GO TO 50
C
         IF(MULTIMOL.EQ.1) THEN
            JJ=IDT(KID,KG)
         ELSE
            JJ=IDTV(MM,KID,KG)
         ENDIF
         
         IF(JJ.EQ.0)THEN
            GO TO 30
         ENDIF
         
         IF(KID.LE.2) THEN  ! PRESSURE
            IF(MULTIMOL.EQ.1) THEN
               TT1TOTP(1,KID,KG) = TT1P(JJ)
            ELSE
               TT1TOTP(MM,KID,KG) = TT1PM(MM,JJ)
            ENDIF
         ELSE               ! CONCENTRATION
            IF(MULTIMOL.EQ.1) THEN
               TT1TOTC(1,KID-2,KG) = TT1C(JJ)
            ELSE
               TT1TOTC(MM,KID-2,KG) = TT1CM(MM,JJ)
            ENDIF
         ENDIF
         GO TO 50
C
C        PRESCRIBED VALUES
C        
   30    CONTINUE
         II=IZADLOCALDI(KID,KG)
         IF(II.GT.0) THEN
           IF(MULTIMOL.EQ.1) THEN
             IF(KID.LE.2) THEN 
               TT1TOTP(1,KID,KG)   = ZADATA1(II)
             ELSE
               TT1TOTC(1,KID-2,KG) = ZADATA1(II)
             ENDIF  
           ELSE
             IF(KID.LE.2) THEN
               TT1TOTP(MM,KID,KG)   = ZADATAM1(MM,II)
             ELSE
               TT1TOTC(MM,KID-2,KG) = ZADATAM1(MM,II) 
             ENDIF
           ENDIF
         ENDIF

   50    CONTINUE
   77    IF(KG.LT.NPT) GO TO 20
   
  200 CONTINUE   
C
C     LYMPHATIC SYSTEM
C
      IF(INDLYMPHC.EQ.0) GO TO 800
      KG=0   

  855 KG = KG + 1
      IF(KG.LE.NPT.AND.IPIPENODV(KG).EQ.1) THEN
         IF(KG.EQ.NPT) GO TO 800
         GO TO 855
      ENDIF
C
      JJ=IDLYMPHC(MM,KG) 
C
      IF(JJ.EQ.0)THEN
         DO K=1,NZADLY 
            NODE=INPUTLY(MM,1,K)
            IF(NODE.EQ.KG) THEN
               TT1TOTC(MM,7,KG)=ZADALYMH1(MM,K)
               GO TO 850
            ENDIF
         ENDDO
      ENDIF
C
      IF(MULTIMOL.EQ.1) THEN
         TT1TOTC(MM,7,KG) = TT1C(JJ)
      ELSE
         TT1TOTC(MM,7,KG) = TT1CM(MM,JJ)
      ENDIF
C     
  850 CONTINUE    
      IF(KG.LT.NPT) GO TO 855
C
  800 CONTINUE
C
C
      IF(NDIMCELL.EQ.0) RETURN
C
C     CONCENTRATIONS WITHIN CELLS   
C
      DO 400  NC=1,NDIMCELL
C   
         KG = 0
  220    CONTINUE

  255    KG = KG + 1
         IF(KG.LE.NPT.AND.IPIPENODV(KG).EQ.1) THEN
            IF(KG.EQ.NPT) GO TO 300
            GO TO 255
         ENDIF
         IF(KG.GT.NPT) GO TO 300     
C
         IF(IDTVCELL(MM,NC,KG).EQ.0)THEN
            GO TO 230
         ENDIF
         JJ=IDTVCELL(MM,NC,KG)
         IF(MULTIMOL.EQ.1) THEN
            TT1TOTC(1,NC+2,KG)  = TT1C(JJ)
         ELSE
            TT1TOTC(MM,NC+2,KG) = TT1CM(MM,JJ)
         ENDIF
         GO TO 300
C
C        PRESCRIBED VALUES
C
  230    CONTINUE
         II=IZADLOCALDI(4+NC,KG)
         IF(II.GT.0) THEN
           IF(MULTIMOL.EQ.1) THEN
             TT1TOTC(1,NC+2,KG)  = ZADATA1(II)
           ELSE
             TT1TOTC(MM,NC+2,KG) = ZADATAM1(MM,II)
           ENDIF
         ENDIF
  300    CONTINUE
C
         IF(KG.LT.NPT) GO TO 220            
  400 CONTINUE
C
      RETURN
      END
C=======================================================================
C
C=======================================================================
      SUBROUTINE TGRAFRMULTIMOL(TT1TOTP,TT1TOTC,TT1C,TT1CM,IDT,IDVS,
     1  NZADNODVS,ZADATAVSV,VELOC,IPIPENODV,NPT,II,NASLOV,KOR,VREME,
     2  ICON,JEDN,NGET,NTOTA,IIZLAZ,IPRINTVEL,ISMEARED,NDIMCELL,
     3  MULTIMOL,JEDNCONC,JEDNCMAX,INDLYMPHC)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)

      COMMON /REPEAT/ LCORD,LTABK,LTABC,LNTAKV,LNTACV,LIDTE,LIDT,LTCONS,
     1LMAX,LMAXA,LMAXM,LMHT,LNTAQE,LQEFN,LNTAQP,LQPFN,LNTAOK,LTOKFN,
     2LNTAHP,LHPFN,LNTAHR,LHRFN,LTT1,LTT2,LTT0,LSK,LCONM,LF,LFC,LNEL,
     3LIBFK,LFAKP,LISKC,LGUSM,LTOPM,LTMNM,LFOHR,LFVPOT
      COMMON /ZADATA/ LNZADJ,LNZADF,LZADFM,NZADP
      COMMON/DARCYEQ/ ELDARCYX,ELDARCYY,ELDARCYZ,VDARCY,PINLET,
     1       DARCYX,JEDNDARCY,ISOLVER,IDARCY,LDARCYD,LDARCYMI,
     2       LIDARCYMA,NPTINDARCY
      COMMON/ELEMENTS2D3D/NELEDAT(100,50),RNELDAT(100,10)
      COMMON/CCELLIN/INDCELLIN,INDCELLINV(10),VFVS(10,5),DIAMVS(10,5),
     1 RAVVS(10,5),DDIFFICY(10,10),DDIFFIVS(10,10,5),DDIFFICM(10,10,5)
     2 ,IPARTIVS(10,10,5),PARTIVS(10,10,5),NDIMVS,NVSMAX,LIDVS,NZADVS,
     3 LNZADNODVS,LNZADNFVS,LNZADFVS,LZADVALUEVS,LZADATAVS0,LZADATAVS
      
      DIMENSION TT1TOTP(MULTIMOL,2,NPT),TT1TOTC(MULTIMOL,7,NPT)
      DIMENSION IDT(4,NPT),VELOC(6,NPT),IPIPENODV(NPT),TT1C(JEDNCONC),
     1          TT1CM(MULTIMOL,JEDNCMAX)
      DIMENSION IDVS(MULTIMOL,NDIMVS,NVSMAX,NPT),NZADNODVS(4,NZADVS),
     1          ZADATAVSV(NZADVS),CONCVES(6)
c
	CHARACTER*1 NASLOV(80)
C
C     PRITISAK
C
      DO MM = 1, MULTIMOL
            
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
 
      WRITE(II,5003) NASLOV
 5003 FORMAT(80A1)
      WRITE(II,5004) KOR
 5004 FORMAT('CVORNI PRITISAK - MOLECULE:',I5/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,5008) MM+18,KOR,VREME
 5008 FORMAT(
     1   '         2         1         1',I10,'         2         2'/
     1   '         1         1',I10/
     1   E13.5)
C      
      DO IN = 1, NPT
        WRITE(II,1000) IN
	  IF(DABS(TT1TOTP(MM,1,IN)).LT.1.D-15) TT1TOTP(MM,1,IN)=0.D0
	  IF(DABS(TT1TOTP(MM,2,IN)).LT.1.D-15) TT1TOTP(MM,2,IN)=0.D0
	  IF(ISMEARED.EQ.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOTP(MM,1,IN), TT1TOTP(MM,1,IN)
        ELSE IF (ISMEARED.NE.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,2000) TT1TOTP(MM,1,IN), TT1TOTP(MM,1,IN) 
        ELSE
          WRITE(II,2000) TT1TOTP(MM,2,IN), TT1TOTP(MM,1,IN)
        ENDIF  
      ENDDO
      WRITE(II,1100) IND
      
      ENDDO
C
C     KONCENTRACIJE
C     
      DO MM = 1, MULTIMOL
C
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,6004) MM,KOR
 6004 FORMAT('CVORNE KONCENTRACIJE - MOLECULE:',I5/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,6008) MM+14,KOR,VREME
 6008 FORMAT(
     1   '         2         1         1',I10,'         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        IF(ISMEARED.EQ.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,3000) TT1TOTC(MM,1,IN), TT1TOTC(MM,1,IN), 
     1                   0.0, 0.0, 0.0, 0.0, 0.0 
        ELSE IF (ISMEARED.NE.0.AND.IPIPENODV(IN).EQ.1) THEN
          WRITE(II,3000) TT1TOTC(MM,1,IN), TT1TOTC(MM,1,IN), 
     1                   0.0, 0.0, 0.0, 0.0, 0.0
        ELSE
          WRITE(II,3000) (TT1TOTC(MM,IDEG,IN), IDEG = 1,7)
        ENDIF
      ENDDO
      WRITE(II,1100) IND
C
 1000 FORMAT(I10)
 1100 FORMAT(I6)
 2000 FORMAT(2E15.7, I5)
 3000 FORMAT(7E15.7)
 
      ENDDO
C
C     CASE WITH CELL INTERIOR
C
      IF(INDCELLIN.EQ.0) GOTO 100
C
      DO MM = 1, MULTIMOL
C
        IND  = -1
        ITYP = 58
        WRITE(II,1100) IND
        WRITE(II,1100) ITYP
        WRITE(II,5003) NASLOV
        WRITE(II,9007) MM
        WRITE(II,9001) KOR
        WRITE(II,9006) 1,1,1,MM+22,2,6
        WRITE(II,9006) 1,1,KOR,KOR
        WRITE(II,9201) VREME 
        WRITE(II,9202) NDIMCELL,(INDCELLINV(NC), NC = 1,6)

 9001   FORMAT(' DATE'/
     1       ' EMPTY'/
     1       ' LOAD CASE',I10)
 9006   FORMAT(6I10)
 9007   FORMAT(' MOLECULE DATA',I5)
 9201   FORMAT(6E20.12)
 9202   FORMAT(7I10)
C     
        DO IN = 1, NPT
          WRITE(II,1000) IN
        
          DO NC=1,NDIMCELL
            CALL CLEAR(CONCVES,6)
            NVISE=INDCELLINV(NC)
          
            DO IVS = 1,NVISE
              JJ=IDVS(MM,NC,IVS,IN)
              IF(JJ.EQ.0) THEN
                DO J=1,NZADVS   
                  NODE=NZADNODVS(1,J)
                  IMM=NZADNODVS(2,J)
            	  ICC=NZADNODVS(3,J)
            	  IDOF=NZADNODVS(4,J)
            	 IF(NODE.EQ.IN.AND.IMM.EQ.MM.AND.ICC.EQ.NC.AND.IDOF.EQ.IVS)
     1            THEN
                    CONCVES(IVS)=ZADATAVSV(J)
                  ENDIF
                ENDDO 
              ELSE
                IF(MULTIMOL.EQ.1) THEN
                  CONCVES(IVS) = TT1C(JJ)
                ELSE
                  CONCVES(IVS) = TT1CM(MM,JJ)
                ENDIF
              ENDIF 
            ENDDO
            ! END LOOP OVER VESICLES
          
            WRITE(II,3000) (CONCVES(IDEG), IDEG = 1,6)
          ENDDO 
          ! END LOOP OVER CELLS
        ENDDO
        ! END LOOP OVER NODES
        WRITE(II,1100) IND
      ENDDO
      
  100 IF (IPRINTVEL.EQ.0) RETURN
C
C     NODAL VELOCITIES - TISSUE
C     
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,7004) KOR
 7004 FORMAT('CVORNE BRZINE'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,7008) KOR,VREME
 7008 FORMAT(
     1   '         2         1         1        11         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        WRITE(II,3000) VELOC(4,IN),VELOC(5,IN),VELOC(6,IN),0.,0.,0.
      ENDDO
      WRITE(II,1100) IND 
C
C     NODAL VELOCITIES - CAPILLARY
C     
      IND  = -1
      NC   =  1
      ITYP = 55
      WRITE(II,1100) IND
      WRITE(II,1100) ITYP
      WRITE(II,5003) NASLOV
      WRITE(II,8004) KOR
 8004 FORMAT('CVORNE BRZINE - CAPILLARY'/
     1       'DATUM'/
     1       'PRAZNA'/
     1       'SLUCAJ OPTERECENJA:',I10)
      WRITE(II,8008) KOR,VREME
 8008 FORMAT(
     1   '         2         1         1        14         2         6'/
     1   '         1         1',I10/
     1   E13.5)
C
      DO IN = 1, NPT
        WRITE(II,1000) IN
        WRITE(II,3000) VELOC(1,IN),VELOC(2,IN),VELOC(3,IN),0.,0.,0.
      ENDDO
      WRITE(II,1100) IND
C
      RETURN
      END
C=======================================================================
C=======================================================================
      SUBROUTINE ZASTIT
      RETURN
   10 OPEN(38,FILE='C:\\DOS\\4307.CPI',ERR=10,
     +     ACCESS='SEQUENTIAL',STATUS='OLD')
      CLOSE(38)
      RETURN
      END
C=======================================================================
C=======================================================================
      SUBROUTINE CZINIT
      RETURN
      END
C=======================================================================
C=======================================================================